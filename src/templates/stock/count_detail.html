{% extends "base/base.html" %}

{% block title %}Detail inventaire{% endblock %}

{% block breadcrumb %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-900">Detail inventaire</h1>
        <p class="text-sm text-gray-500 mt-1">{{ stock_count.created_at|date:"d/m/Y H:i" }} - {{ stock_count.get_status_display }}</p>
    </div>
    <a href="{% url 'stock:count-list' %}" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm">
        Retour inventaires
    </a>
</div>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
            <h3 class="font-semibold text-gray-900">Lignes de comptage</h3>
            <span class="text-sm text-gray-500">{{ counted_lines }} / {{ total_lines }} lignes comptees</span>
        </div>
        <div class="px-5 py-3 border-b border-gray-100 bg-gray-50">
            <input
                id="count-line-search"
                type="text"
                placeholder="Rechercher un produit dans cet inventaire..."
                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500"
                autocomplete="off"
            >
        </div>

        <form method="post">
            {% csrf_token %}
            <table class="w-full">
                <thead>
                    <tr class="bg-gray-50 border-b border-gray-100">
                        <th class="text-left px-5 py-3 text-xs font-semibold text-gray-600 uppercase">Produit</th>
                        <th class="text-right px-5 py-3 text-xs font-semibold text-gray-600 uppercase">Systeme</th>
                        <th class="text-right px-5 py-3 text-xs font-semibold text-gray-600 uppercase">Compte</th>
                        <th class="text-right px-5 py-3 text-xs font-semibold text-gray-600 uppercase">Ecart</th>
                    </tr>
                </thead>
                <tbody id="count-lines-body" class="divide-y divide-gray-50">
                    {% for line in stock_count.lines.all %}
                    <tr class="hover:bg-gray-50" data-search="{{ line.product.name|lower }} {{ line.product.sku|default:''|lower }}">
                        <td class="px-5 py-3 text-sm text-gray-800">{{ line.product.name }}</td>
                        <td class="px-5 py-3 text-sm text-right text-gray-700">{{ line.system_qty }}</td>
                        <td class="px-5 py-3 text-right">
                            {% if stock_count.status == 'IN_PROGRESS' %}
                            <input type="number" name="counted_{{ line.id }}" value="{{ line.counted_qty|default_if_none:'' }}" min="0"
                                   class="w-24 px-2 py-1.5 border border-gray-300 rounded-lg text-sm text-right">
                            {% else %}
                            <span class="text-sm text-gray-700">{{ line.counted_qty|default:"-" }}</span>
                            {% endif %}
                        </td>
                        <td class="px-5 py-3 text-sm text-right {% if line.variance and line.variance < 0 %}text-red-600{% elif line.variance and line.variance > 0 %}text-orange-600{% else %}text-gray-700{% endif %}">
                            {% if line.variance is None %}-{% else %}{{ line.variance }}{% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="px-5 py-12 text-center text-gray-500">Aucune ligne de comptage.</td>
                    </tr>
                    {% endfor %}
                    <tr id="count-lines-no-match" class="hidden">
                        <td colspan="4" class="px-5 py-8 text-center text-gray-500">Aucun produit ne correspond a cette recherche.</td>
                    </tr>
                </tbody>
            </table>

            {% if stock_count.status == 'IN_PROGRESS' %}
            <div class="px-5 py-4 border-t border-gray-100 bg-gray-50">
                <button type="submit" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg text-sm font-medium">
                    Enregistrer les quantites comptees
                </button>
            </div>
            {% endif %}
        </form>
    </div>

    <div class="space-y-4">
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
            <h3 class="font-semibold text-gray-900 mb-3">Resume</h3>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between"><span class="text-gray-500">Statut</span><span class="font-medium">{{ stock_count.get_status_display }}</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Cree le</span><span class="font-medium">{{ stock_count.created_at|date:"d/m/Y H:i" }}</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Cree par</span><span class="font-medium">{{ stock_count.created_by.get_full_name|default:"-" }}</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Lignes comptees</span><span class="font-medium">{{ counted_lines }}/{{ total_lines }}</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Lignes restantes</span><span class="font-medium">{{ remaining_lines }}</span></div>
                {% if stock_count.completed_at %}
                <div class="flex justify-between"><span class="text-gray-500">Termine le</span><span class="font-medium">{{ stock_count.completed_at|date:"d/m/Y H:i" }}</span></div>
                {% endif %}
            </div>
            {% if stock_count.notes %}
            <div class="mt-4 p-3 bg-gray-50 rounded-lg text-sm text-gray-700">{{ stock_count.notes }}</div>
            {% endif %}
        </div>

        {% if stock_count.status == 'IN_PROGRESS' %}
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
            <form method="post" action="{% url 'stock:count-complete' stock_count.id %}">
                {% csrf_token %}
                <button type="submit" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium"
                        onclick="return confirm('Terminer cet inventaire et appliquer les ajustements ?');">
                    Terminer l'inventaire
                </button>
            </form>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function () {
        function normalize(value) {
            return (value || "").toLowerCase().trim();
        }

        function filterCountLines(query) {
            const body = document.getElementById("count-lines-body");
            if (!body) return;

            const rows = Array.from(body.querySelectorAll("tr[data-search]"));
            const noMatchRow = document.getElementById("count-lines-no-match");
            const term = normalize(query);
            let visible = 0;

            rows.forEach((row) => {
                const haystack = normalize(row.getAttribute("data-search"));
                const show = term === "" || haystack.includes(term);
                row.classList.toggle("hidden", !show);
                if (show) visible += 1;
            });

            if (noMatchRow) {
                noMatchRow.classList.toggle("hidden", visible !== 0 || rows.length === 0);
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            const input = document.getElementById("count-line-search");
            if (!input) return;
            filterCountLines(input.value);
            input.addEventListener("input", function (event) {
                filterCountLines(event.target.value);
            });
        });
    })();
</script>
{% endblock %}
