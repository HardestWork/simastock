{% extends "base/base.html" %}
{% load boutique_tags humanize %}

{% block title %}Tableau de bord — Boutique Manager{% endblock %}

{% block breadcrumb %}
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-900">Tableau de bord</h1>
    <p class="text-sm text-gray-500 mt-1">Vue d'ensemble — {{ current_store.name }}</p>
</div>
{% endblock %}

{% block content %}
<!-- KPI Cards Row -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <!-- CA du jour -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
        <div class="flex items-center justify-between mb-3">
            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-coins text-blue-600"></i>
            </div>
            {% if today_vs_yesterday >= 0 %}
            <span class="text-xs font-medium text-green-600 bg-green-50 px-2 py-1 rounded-full">
                <i class="fas fa-arrow-up mr-1"></i>+{{ today_vs_yesterday|floatformat:1 }}%
            </span>
            {% else %}
            <span class="text-xs font-medium text-red-600 bg-red-50 px-2 py-1 rounded-full">
                <i class="fas fa-arrow-down mr-1"></i>{{ today_vs_yesterday|floatformat:1 }}%
            </span>
            {% endif %}
        </div>
        <p class="text-2xl font-bold text-gray-900">{{ today_sales|currency }}</p>
        <p class="text-sm text-gray-500 mt-1">Chiffre d'affaires du jour</p>
    </div>

    <!-- Nombre de ventes -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
        <div class="flex items-center justify-between mb-3">
            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-shopping-cart text-green-600"></i>
            </div>
        </div>
        <p class="text-2xl font-bold text-gray-900">{{ today_orders|default:0 }}</p>
        <p class="text-sm text-gray-500 mt-1">Ventes aujourd'hui</p>
    </div>

    <!-- Panier moyen -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
        <div class="flex items-center justify-between mb-3">
            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-chart-line text-purple-600"></i>
            </div>
        </div>
        <p class="text-2xl font-bold text-gray-900">{{ today_avg_basket|currency }}</p>
        <p class="text-sm text-gray-500 mt-1">Panier moyen</p>
    </div>

    <!-- En attente paiement -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
        <div class="flex items-center justify-between mb-3">
            <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-clock text-yellow-600"></i>
            </div>
            {% if pending_payments_count > 0 %}
            <span class="text-xs font-medium text-yellow-600 bg-yellow-50 px-2 py-1 rounded-full">Action requise</span>
            {% endif %}
        </div>
        <p class="text-2xl font-bold text-gray-900">{{ pending_payments_count|default:0 }}</p>
        <p class="text-sm text-gray-500 mt-1">Ventes en attente</p>
    </div>
</div>

<!-- Second Row: Charts + Lists -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Sales Chart -->
    <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 p-5">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-gray-900">Évolution du CA (30 derniers jours)</h3>
            <div class="flex gap-2">
                <button class="px-3 py-1 text-xs rounded-lg bg-primary-50 text-primary-700 font-medium">30j</button>
                <button class="px-3 py-1 text-xs rounded-lg text-gray-500 hover:bg-gray-50">7j</button>
            </div>
        </div>
        <canvas id="salesChart" height="200"></canvas>
    </div>

    <!-- Top Products -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
        <h3 class="font-semibold text-gray-900 mb-4">Top 5 produits</h3>
        <div class="space-y-3">
            {% for item in top_products %}
            <div class="flex items-center gap-3">
                <span class="w-6 h-6 bg-gray-100 rounded-full flex items-center justify-center text-xs font-bold text-gray-600">{{ forloop.counter }}</span>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 truncate">{{ item.product__name }}</p>
                    <p class="text-xs text-gray-500">{{ item.total_qty }} vendus</p>
                </div>
                <span class="text-sm font-semibold text-gray-900">{{ item.total_revenue|currency }}</span>
            </div>
            {% empty %}
            <p class="text-sm text-gray-500 text-center py-4">Aucune vente</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Third Row: Recent Sales + Alerts -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Recent Sales -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100">
        <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
            <h3 class="font-semibold text-gray-900">Ventes récentes</h3>
            <a href="{% url 'sales:sale-list' %}" class="text-sm text-primary-600 hover:underline">Voir tout</a>
        </div>
        <div class="divide-y divide-gray-50">
            {% for sale in recent_sales %}
            <a href="{% url 'sales:sale-detail' sale.id %}" class="flex items-center justify-between px-5 py-3 hover:bg-gray-50">
                <div>
                    <p class="text-sm font-medium text-gray-900">{{ sale.invoice_number|default:"Brouillon" }}</p>
                    <p class="text-xs text-gray-500">{{ sale.customer.full_name|default:"Client anonyme" }} · {{ sale.created_at|timesince }} ago</p>
                </div>
                <div class="text-right">
                    <p class="text-sm font-semibold text-gray-900">{{ sale.total|currency }}</p>
                    <span class="inline-block px-2 py-0.5 text-xs font-medium rounded-full {{ sale.status|status_badge }}">
                        {{ sale.get_status_display }}
                    </span>
                </div>
            </a>
            {% empty %}
            <p class="text-sm text-gray-500 text-center py-6">Aucune vente récente</p>
            {% endfor %}
        </div>
    </div>

    <!-- Alerts Summary -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100">
        <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
            <h3 class="font-semibold text-gray-900">Alertes</h3>
            <a href="{% url 'alerts:alert-list' %}" class="text-sm text-primary-600 hover:underline">Voir tout</a>
        </div>
        <div class="p-5 space-y-3">
            {% if low_stock_count > 0 %}
            <div class="flex items-center gap-3 p-3 bg-orange-50 rounded-lg">
                <div class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-exclamation-triangle text-orange-600 text-sm"></i>
                </div>
                <div>
                    <p class="text-sm font-medium text-orange-900">{{ low_stock_count }} produit(s) en stock faible</p>
                    <p class="text-xs text-orange-700">Réapprovisionnement recommandé</p>
                </div>
            </div>
            {% endif %}
            {% if overdue_credits_count > 0 %}
            <div class="flex items-center gap-3 p-3 bg-red-50 rounded-lg">
                <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-clock text-red-600 text-sm"></i>
                </div>
                <div>
                    <p class="text-sm font-medium text-red-900">{{ overdue_credits_count }} crédit(s) en retard</p>
                    <p class="text-xs text-red-700">Relance nécessaire</p>
                </div>
            </div>
            {% endif %}
            {% if not low_stock_count and not overdue_credits_count %}
            <p class="text-sm text-gray-500 text-center py-4">Aucune alerte active</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('salesChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ chart_labels|safe }},
                datasets: [{
                    label: 'CA (FCFA)',
                    data: {{ chart_data|safe }},
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false } },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(val) {
                                return val.toLocaleString('fr-FR') + ' FCFA';
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
