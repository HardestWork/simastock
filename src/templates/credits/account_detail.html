{% extends "base/base.html" %}
{% load boutique_tags %}

{% block title %}Compte credit{% endblock %}

{% block breadcrumb %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-900">Compte credit: {{ account.customer.full_name }}</h1>
        <p class="text-sm text-gray-500 mt-1">{{ account.customer.phone }} - {{ account.store.name }}</p>
    </div>
    <div class="flex gap-2">
        <a href="{% url 'credits:ledger' account.id %}" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm">Grand livre</a>
        <a href="{% url 'credits:schedule-list' account.id %}" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm">Echeances</a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2 space-y-6">
        <div id="credit-repayment" class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
            <h3 class="font-semibold text-gray-900 mb-3">Remboursement du credit</h3>
            <form method="post" action="{% url 'credits:credit-payment' account.id %}" class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
                {% csrf_token %}
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Montant</label>
                    {{ payment_form.amount }}
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Reference</label>
                    {{ payment_form.reference }}
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Notes</label>
                    {{ payment_form.notes }}
                </div>
                <div>
                    <label class="flex items-center gap-2 text-xs text-gray-600 mb-1">
                        <input type="checkbox" name="print_receipt" checked class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                        Imprimer la facture
                    </label>
                    <button type="submit" class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm">Rembourser</button>
                </div>
            </form>
            {% if account.balance > 0 and account.is_active %}
            <div class="mt-4 pt-4 border-t border-gray-100">
                <form method="post" action="{% url 'credits:credit-repay-all' account.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="print_receipt" value="on">
                    <button
                        type="submit"
                        class="w-full md:w-auto px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium"
                        onclick="return confirm('Confirmer le remboursement total du compte ?');"
                    >
                        Tout rembourser (1 clic)
                    </button>
                </form>
            </div>
            {% endif %}
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <h3 class="font-semibold text-gray-900">Dernieres ecritures</h3>
                <a href="{% url 'credits:ledger' account.id %}" class="text-sm text-primary-600 hover:underline">Voir tout</a>
            </div>
            <table class="w-full">
                <thead>
                    <tr class="bg-gray-50 border-b border-gray-100">
                        <th class="text-left px-5 py-3 text-xs font-semibold text-gray-600 uppercase">Date</th>
                        <th class="text-left px-5 py-3 text-xs font-semibold text-gray-600 uppercase">Type</th>
                        <th class="text-left px-5 py-3 text-xs font-semibold text-gray-600 uppercase">Reference</th>
                        <th class="text-right px-5 py-3 text-xs font-semibold text-gray-600 uppercase">Montant</th>
                        <th class="text-right px-5 py-3 text-xs font-semibold text-gray-600 uppercase">Solde</th>
                        <th class="text-right px-5 py-3 text-xs font-semibold text-gray-600 uppercase">Action</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-50">
                    {% for entry in ledger_entries %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-5 py-3 text-sm text-gray-700">{{ entry.created_at|date:"d/m/Y H:i" }}</td>
                        <td class="px-5 py-3 text-sm text-gray-700">{{ entry.get_entry_type_display }}</td>
                        <td class="px-5 py-3 text-sm text-gray-600">{{ entry.reference|default:"-" }}</td>
                        <td class="px-5 py-3 text-sm text-right {% if entry.amount > 0 %}text-red-600{% else %}text-green-700{% endif %}">{{ entry.amount|currency }}</td>
                        <td class="px-5 py-3 text-sm text-right font-medium text-gray-900">{{ entry.balance_after|currency }}</td>
                        <td class="px-5 py-3 text-right">
                            {% if entry.entry_type == 'CREDIT_PAYMENT' %}
                            <a href="{% url 'credits:credit-payment-receipt' account.id entry.id %}" class="text-sm text-primary-600 hover:underline" target="_blank">
                                Facture
                            </a>
                            {% else %}
                            <span class="text-xs text-gray-400">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="6" class="px-5 py-10 text-center text-gray-500">Aucune ecriture.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="space-y-4">
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
            <h3 class="font-semibold text-gray-900 mb-3">Situation du compte</h3>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between"><span class="text-gray-500">Solde</span><span class="font-bold {% if account.balance > 0 %}text-red-600{% else %}text-green-700{% endif %}">{{ account.balance|currency }}</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Plafond</span><span class="font-medium">{{ account.credit_limit|currency }}</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Disponible</span><span class="font-medium {% if account.available_credit < 0 %}text-red-600{% else %}text-green-700{% endif %}">{{ account.available_credit|currency }}</span></div>
                <div class="flex justify-between"><span class="text-gray-500">Statut</span><span class="font-medium">{% if account.is_active %}Actif{% else %}Inactif{% endif %}</span></div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold text-gray-900">Echeances</h3>
                <a href="{% url 'credits:schedule-create' account.id %}" class="text-sm text-primary-600 hover:underline">Ajouter</a>
            </div>
            <div class="space-y-2 text-sm">
                {% for schedule in schedules|slice:":8" %}
                <div class="flex justify-between">
                    <span class="text-gray-600">{{ schedule.due_date|date:"d/m/Y" }} ({{ schedule.get_status_display }})</span>
                    <span class="font-medium">{{ schedule.amount_due|currency }}</span>
                </div>
                {% empty %}
                <p class="text-gray-500">Aucune echeance.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
